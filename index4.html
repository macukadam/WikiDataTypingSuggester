<!DOCTYPE html>
<html>

<head>
    <script src="jquery-3.3.1.min.js"></script>
    <script src="textcomp.js"></script>
    <script src="./wikidata-sdk.js"></script>
    <script src="./js-md5.js"></script>
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="./jquery-dialog.min.js"></script>
</head>

<body>

    <div style="display: none;">
        <div id="modal">
        </div>
    </div>

    <div style="display: none;">
        <div id="modal1">
            <textarea class="form-control" id="textarea" style="resize: none;"></textarea>
        </div>
    </div>
</body>

<script>
    var map = {
        17: false,
        32: false
    };
    $(document).keydown(function (e) {
        if (e.keyCode in map) {
            map[e.keyCode] = true;
            if (map[17] && map[32]) {
                $("#modal1").dialog({});
            }
        }
    }).keyup(function (e) {
        if (e.keyCode in map) {
            map[e.keyCode] = false;
        }
    });

    function closeDiag() {
        $('#textcomplete-dropdown-1').show();
    }

    function openDiag(title, imgSource, content) {
        $('#textcomplete-dropdown-1').hide();
        $("#modal").append('<h1><a id="diagTitle" href="">' + title + '</a></h1>')
            .append('<img id="diagImage"  height="250" width="250" src="' + imgSource + '" alt="Image not found";>')
            .append('<p id="diagContent">' + content + '</p>')
            .append('<button data-dialog-close onclick="closeDiag()">Close</button>')
            .dialog({});
    }
</script>

<script>
    var autoCopleteActivated = false;

    createAutoComplete();

    function destroyAutoComplete() {
        $('#textarea').textcomplete('destroy');
    }

    var myVar;

    function createAutoComplete() {
        var words = [];
        var data = {};
        $('textarea').textcomplete([{
            match: /(^|\b)(\w{2,})$/,
            search: function (term, callback) {
                clearTimeout(myVar);
                myVar = setTimeout(function () {
                    data = searchTextOnWikidata(term);
                    words = [];
                    data.search.forEach(element => {
                        words.push(element.label);
                    });
                    callback($.map(words, function (word) {
                        return word;
                    }));
                }, 1000);

            },
            replace: function (word) {
                return word + ' ';
            }
        }], {
            maxCount: 20,
            onKeydown: function (e, commands) {
                if (e.keyCode === 39) {
                    var activeLi = $("ul[id*=textcomplete-dropdown-1] li.active");
                    var activeIndex = activeLi.index();

                    imageQ = "https://www.wikidata.org/w/api.php?action=wbgetclaims&entity=" + data.search[
                            activeIndex].title +
                        "&property=P18&format=json"

                    imageSource = '';

                    try {
                        var imgText = searchQuery(imageQ).claims.P18[0].mainsnak.datavalue.value.split(' ')
                            .join(
                                '_');
                        var hash = md5(imgText);
                        var a = hash.substring(0, 1);
                        var b = hash.substring(1, 2);
                        imageSource = "https://upload.wikimedia.org/wikipedia/commons/" + a + "/" + a + b +
                            "/" + imgText;
                    } catch (e) {
                        console.log("Image not found");
                    }

                    openDiag(words[activeIndex], imageSource, data.search[activeIndex].description);
                    return true;
                }
            }
        });
    }

    function searchTextOnWikidata(text) {
        const Http = new XMLHttpRequest();
        const url = wdk.searchEntities(text, 'en', 20, 'json');
        Http.open("GET", url, false);
        Http.send();

        if (Http.readyState == 4 && Http.status == 200) {
            var response = JSON.parse(Http.response);
            return response;
        }
    }

    function searchQuery(imgQuey) {
        const Http = new XMLHttpRequest();
        const url = imgQuey
        Http.open("GET", url, false);
        Http.send();
        if (Http.readyState == 4 && Http.status == 200) {
            var response = JSON.parse(Http.response);
            return response;
        }
    }
</script>

</html>