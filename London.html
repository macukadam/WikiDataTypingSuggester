<!DOCTYPE html>
<html>

<head>
    <script src="./js/jquery-3.3.1.min.js"></script>
    <script src="./js/textcomp.js"></script>
    <script src="./js/searchBy.js"></script>
</head>

<div style="display: none;">
    <div id="modal">
    </div>
</div>

<body>
    <div id="textDiv" style="display:none" class="form-group">
        <label for="textarea">WikiData data search:</label>
        <textarea class="form-control" id="textarea" style="resize: none;"></textarea>
    </div>
    <div class="main">
        <div>
            <div class="add-memory-header">
                <div style="display: inline-block; width: 100%;">
                    <div style="float: right;">
                        <button style="height: 26px;" onclick="searchByInsance()">Search by Instance</button>
                        <button style="height: 26px;" onclick="getPropertiesFromMemo()">Search by Properities</button>
                        <button class="btn-primary" id="button-dialog" onclick="autoCompleteSwitch()">WikiData
                            Annotation</button>
                    </div>
                    <div style="float: right;">
                        <textarea id="qryinput" type="text" style="resize: none; height: 26px;"></textarea>
                    </div>
                </div>
            </div>
            <br>
            <br>
            <h1>London Alleys</h1>
            <div>
                <div style="width: 100%;" id="editor">
                    <p><span style="color: rgb(0, 0, 0);">Though the Tower was always a part of </span><a href="http://www.wikidata.org/wiki/Q84" target="_blank" style="background-color: rgb(255, 255, 255);">London</a><span style="color: rgb(0, 0, 0);">, </span><a href="http://www.wikidata.org/wiki/Q5933" target="_blank" style="background-color: rgb(255, 255, 255);">Westminster Abbey</a><span style="color: rgb(0, 0, 0);"> was once over a mile from the capital city. For&nbsp;</span><strong style="color: rgb(0, 0, 0);">centuries</strong><span style="color: rgb(0, 0, 0);">, "London" just covered the area corresponding more or less to the </span><a href="http://www.wikidata.org/wiki/Q2202509" target="_blank" style="background-color: rgb(255, 255, 255);">Roman city</a><span style="color: rgb(0, 0, 0);">. Today, this part of London is still called the City of London, and is the heart of the bigger "London".</span></p><p><span style="color: rgb(0, 0, 0);">&nbsp;&nbsp;&nbsp;Until recently, "the City" was home to hundreds of thousands of people; but today its population is actually well less than ten thousand! Today the City is the heart of London's financial district, full of bankers and businessmen by day, almost&nbsp;</span><strong style="color: rgb(0, 0, 0);">deserted</strong><span style="color: rgb(0, 0, 0);">&nbsp;by night.</span></p><p><span style="color: rgb(0, 0, 0);">&nbsp;&nbsp;&nbsp;Back in the&nbsp;</span><a href="http://www.wikidata.org/wiki/Q12554" target="_blank" style="background-color: rgb(255, 255, 255);">Middle Ages</a><span style="color: rgb(0, 0, 0);">, the City was already becoming too small. In the 11th century,&nbsp;</span><strong style="color: rgb(0, 0, 0);">monks</strong><span style="color: rgb(0, 0, 0);">&nbsp;built a big new&nbsp;</span><strong style="color: rgb(0, 0, 0);">abbey</strong><span style="color: rgb(0, 0, 0);">&nbsp;at </span><a href="http://www.wikidata.org/wiki/Q189960" target="_blank" style="background-color: rgb(255, 255, 255);">Westminster</a><span style="color: rgb(0, 0, 0);">, and King Cnut began to build a palace beside it. King Ethelred, his&nbsp;</span><strong style="color: rgb(0, 0, 0);">successor</strong><span style="color: rgb(0, 0, 0);">, then decided to move his court from the city of Winchester, to the palace of Westminster. Westminster has been the seat of the English, then British, parliament since 1265, and London has been the capital city for even longer.</span></p><p><span style="color: rgb(0, 0, 0);">&nbsp;&nbsp;While the parliament was established in Westminster, the City's growing population kept&nbsp;</span><strong style="color: rgb(0, 0, 0);">spreading</strong><span style="color: rgb(0, 0, 0);">&nbsp;to other villages all round. Villages like Chelsea and Hackney&nbsp;</span><strong style="color: rgb(0, 0, 0);">eventually</strong><span style="color: rgb(0, 0, 0);">&nbsp;became&nbsp;</span><strong style="color: rgb(0, 0, 0);">swallowed up</strong><span style="color: rgb(0, 0, 0);">&nbsp;by the metropolis which kept growing and growing.</span></p><p><span style="color: rgb(0, 0, 0);">&nbsp;&nbsp;Today, Westminster, which contains </span><a href="http://www.wikidata.org/wiki/Q42182" target="_blank" style="background-color: rgb(255, 255, 255);">Buckingham Palace</a><span style="color: rgb(0, 0, 0);">, </span><a href="http://www.wikidata.org/wiki/Q11010" target="_blank" style="background-color: rgb(255, 255, 255);">Parliament of the United Kingdom</a><span style="color: rgb(0, 0, 0);">, </span><a href="http://www.wikidata.org/wiki/Q215255" target="_blank" style="background-color: rgb(255, 255, 255);">Piccadilly Circus</a><span style="color: rgb(0, 0, 0);">, </span><a href="http://www.wikidata.org/wiki/Q129143" target="_blank" style="background-color: rgb(255, 255, 255);">Trafalgar Square</a><span style="color: rgb(0, 0, 0);">, and London's most famous shopping district, is part of the "West End' of Central London. Nearby, </span><a href="http://www.wikidata.org/wiki/Q743535" target="_blank" style="background-color: rgb(255, 255, 255);">Chelsea</a><span style="color: rgb(0, 0, 0);"> is an expensive residential area, and </span><a href="http://www.wikidata.org/wiki/Q5637340" target="_blank" style="background-color: rgb(255, 255, 255);">Hackney</a><span style="color: rgb(0, 0, 0);"> is a working-class district: they are all parts of London.</span></p><p class="ql-align-right"><img src="https://linguapress.com/photos/dore-london.jpg" alt="London"></p><p class="ql-align-right">Poverty in&nbsp;London around 1870, seen by the artist Gustave Dor√©</p><p><br></p>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    var autoCopleteActivated = false;

var wowArray = [];
var finalArray = [];

    function searchByOneEntity(varQ) {
    var someArray = [];

    var response = searchQuery("https://www.wikidata.org/wiki/Special:EntityData/" + varQ + ".json");
    var entities = response.entities;
    for (var entity in entities) {
        var claims = entities[entity].claims;
        var P31 = claims.P31;
        for (var index in P31) {
            var value = P31[index].mainsnak.datavalue.value;
            var id = value.id;
            if (id != null) {
                someArray.push(id);
            }
        }

        var P279 = claims.P279;
        for (var index in P279) {
            var value = P279[index].mainsnak.datavalue.value;
            var id = value.id;
            if (id != null) {
                someArray.push(id);
            }
        }
    }
    
    var diffArray = [];
    finalArray = [];
    finalArray = finalArray.concat(someArray);
    recursivePropSearch(someArray, diffArray);
    return finalArray;
}

    function searchByInsance() {
    var searchText = $('#qryinput').val();
    var select = document.querySelectorAll('p > a');
    var someArray = [];

    for (let i = 0; i < select.length; i++) {
        var splitedArray = select[i].href.split('/');
        var itemQ = splitedArray[splitedArray.length - 1]
        var response = searchQuery("https://www.wikidata.org/wiki/Special:EntityData/" + itemQ + ".json");
        var entities = response.entities;
        for (var entity in entities) {
            var claims = entities[entity].claims;
            var P31 = claims.P31;
            for (var index in P31) {
                var value = P31[index].mainsnak.datavalue.value;
                var id = value.id;
                if (id != null) {
                    someArray.push(id);
                }
            }

            var P279 = claims.P279;
            for (var index in P279) {
                var value = P279[index].mainsnak.datavalue.value;
                var id = value.id;
                if (id != null) {
                    someArray.push(id);
                }
            }
        }
    }
    var diffArray = [];
    finalArray = [];
    finalArray = finalArray.concat(someArray);
    recursivePropSearch(someArray, diffArray);
    return finalArray;
}

    function recursivePropSearch(givenArray, diffArray) {

    givenArray.forEach(element => {
        var response = searchQuery("https://www.wikidata.org/wiki/Special:EntityData/" + element + ".json");
        var entities = response.entities;
        for (var entity in entities) {
            var claims = entities[entity].claims;
            var P31 = claims.P31;
            for (var index in P31) {
                var value = P31[index].mainsnak.datavalue.value;
                var id = value.id;
                if (id != null) {
                    if (!finalArray.includes(id)) {
                        diffArray.push(id);
                        finalArray.push(id);
                    }
                }
            }

            var P279 = claims.P279;
            for (var index in P279) {
                var value = P279[index].mainsnak.datavalue.value;
                var id = value.id;
                if (id != null) {
                    if (!finalArray.includes(id)) {
                        diffArray.push(id);
                        finalArray.push(id);
                    }
                }
            }
        }

    });
    var newDiffArray = [];
    if (diffArray.length != 0) {
        recursivePropSearch(diffArray, newDiffArray);
    }
}

    function getPropertiesFromMemo() {
    var searchText = $('#qryinput').val();
    var select = document.querySelectorAll('p > a');
    var responseArray = [];
    select.forEach(function (val) {
        var splitedArray = val.href.split('/');
        var itemQ = splitedArray[splitedArray.length - 1]
        var response = searchQuery("https://www.wikidata.org/wiki/Special:EntityData/" + itemQ + ".json");
        var entities = response.entities;

        for (var entity in entities) {
            var tempArray = [];
            var claims = entities[entity].claims;
            for (var t in claims) {
                var claim = claims[t];
                for (var k in claim) {
                    try {
                        var value = claim[k].mainsnak.datavalue.value;
                        var id = value.id;
                        if (id != null) {
                            tempArray.push(id);
                        }
                    } catch (error) {

                    }
                }


            }
            responseArray.push(tempArray);
        }
    })
    responseArray.forEach(function (val) {
        alert(val.includes(searchText));
    })
    return responseArray;
}

    searchAutoComplete();

    function searchAutoComplete() {
        var words = [];
        var data = {};
        $('#qryinput').textcomplete([{
            match: /(^|\b)(\w{2,})$/,
            search: function (term, callback) {
            
                data = searchTextOnWikidata($('#qryinput').val());
                words = [];
                data.search.forEach(element => {
                    words.push(element.label);
                });
                callback($.map(words, function (word) {
                    return word;
                }));
            },
            replace: function (word) {
                var i = 0;
                for (i; i < words.length; i++) {
                    if (words[i] == word) {
                        break;
                    }
                }
                $('#qryinput').val('');
                return data.search[i].title;
            }
        }], {
            maxCount: 20,
            onKeydown: function (e, commands) {
                if (e.keyCode === 39) {
                    var activeLi = $("ul[id*=textcomplete-dropdown-1] li.active");
                    var activeIndex = activeLi.index();

                    imageQ = "https://www.wikidata.org/w/api.php?action=wbgetclaims&entity=" + data.search[
                            activeIndex].title +
                        "&property=P18&format=json"

                    imageSource = '';

                    try {
                        var imgText = searchQuery(imageQ).claims.P18[0].mainsnak.datavalue.value.split(' ')
                            .join(
                                '_');
                        var hash = md5(imgText);
                        var a = hash.substring(0, 1);
                        var b = hash.substring(1, 2);
                        imageSource = "https://upload.wikimedia.org/wikipedia/commons/" + a + "/" + a + b +
                            "/" + imgText;
                    } catch (e) {
                        console.log("Image not found");
                    }

                    openDiag(words[activeIndex], imageSource, data.search[activeIndex].description);
                    return true;
                }
            }
        });
    }

    function closeDiag() {
        $('#textcomplete-dropdown-1').show();
        $('#textcomplete-dropdown-2').show();
    }

    function openDiag(title, imgSource, content) {
        $('#textcomplete-dropdown-1').hide();
        $('#textcomplete-dropdown-2').hide();
        $("#modal").append('<h1><a id="diagTitle" href="">' + title + '</a></h1>')
            .append('<img id="diagImage"  height="250" width="250" src="' + imgSource + '" alt="Image not found";>')
            .append('<p id="diagContent">' + content + '</p>')
            .append('<button data-dialog-close onclick="closeDiag()">Close</button>')
            .dialog({});
    }
    
    function autoCompleteSwitch() {
        if (!autoCopleteActivated) {
            createAutoComplete();
            $('#textDiv').show();
            autoCopleteActivated = true;
        } else {
            destroyAutoComplete();
            autoCopleteActivated = false;
            $('#textDiv').hide();
        }
    }

    function destroyAutoComplete() {
        $('#textarea').textcomplete('destroy');
    }
    
    function getInstances(item) {
        var instance = 'P31';
        var lang = 'en';
        const sparql =
            "SELECT ?item ?instance_of ?instance_ofLabel" +
            " WHERE " +
            "{" +
            " ?item wdt:"+ instance +" wd:" + item +
            " SERVICE wikibase:label { bd:serviceParam wikibase:language \"[AUTO_LANGUAGE],"+ lang +"\" }" +
            " OPTIONAL { ?item wdt:" + instance +" ?instance_of. }" +
            "}";
           
        const url = wdk.sparqlQuery(sparql)
        return url;
    }

    function createAutoComplete() {
        var words = [];
        var data = {};
        $('#textarea').textcomplete([{
            match: /(^|\b)(\w{2,})$/,
            search: function (term, callback) {

                data = searchTextOnWikidata($('#textarea').val());
                words = [];
                data.search.forEach(element => {
                    words.push(element.label);
                });
                callback($.map(words, function (word) {
                    return word;
                }));
            },
            replace: function (word) {
                var i = 0;
                for (i; i < words.length; i++) {
                    if (words[i] == word) {
                        break;
                    }
                }
                //var inst = searchByOneEntity(data.search[i].title);
                //instanceArray.push(inst);
                $('.ql-editor').append('<a class="wikidata" href="' + data.search[i].url + '">' + word + '</a>')
                $('#textarea').val('');
                return '';
            }
        }], {
            maxCount: 20,
            onKeydown: function (e, commands) {
                
                if (e.keyCode === 39) {
                    var activeLi = $("ul[id*=textcomplete-dropdown-2] li.active");
                    var activeIndex = activeLi.index();

                    imageQ = "https://www.wikidata.org/w/api.php?action=wbgetclaims&entity=" + data.search[
                            activeIndex].title +
                        "&property=P18&format=json"

                    imageSource = '';

                    try {
                        var imgText = searchQuery(imageQ).claims.P18[0].mainsnak.datavalue.value.split(' ')
                            .join(
                                '_');
                        var hash = md5(imgText);
                        var a = hash.substring(0, 1);
                        var b = hash.substring(1, 2);
                        imageSource = "https://upload.wikimedia.org/wikipedia/commons/" + a + "/" + a + b +
                            "/" + imgText;
                    } catch (e) {
                        console.log("Image not found");
                    }

                    openDiag(words[activeIndex], imageSource, data.search[activeIndex].description);
                    return true;
                }
            }
        });
    }

    function searchTextOnWikidata(text) {
        const Http = new XMLHttpRequest();
        const url = wdk.searchEntities(text, 'en', 20, 'json');
        Http.open("GET", url, false);
        Http.send();

        if (Http.readyState == 4 && Http.status == 200) {
            var response = JSON.parse(Http.response);
            return response;
        }
    }

    function searchQuery(imgQuey) {
        const Http = new XMLHttpRequest();
        const url = imgQuey
        Http.open("GET", url, false);
        Http.send();
        if (Http.readyState == 4 && Http.status == 200) {
            var response = JSON.parse(Http.response);
            return response;
        }
    }
</script>
<script src="./js/wikidata-sdk.js"></script>
<script src="./js/js-md5.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="./js/jquery-dialog.min.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="./js/addmemory.js"></script>
<script src="./js/onepagescroll.js"></script>
<link rel="stylesheet" href="./css/onepage-scroll.css">
<link rel="stylesheet" type="text/css" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU"
    crossorigin="anonymous" />
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="./css/main.css">
<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">


</html>