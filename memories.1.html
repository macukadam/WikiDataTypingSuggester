<!DOCTYPE html>
<html>

<head>
    <script src="./js/jquery-3.3.1.min.js"></script>
    <script src="./js/textcomp.js"></script>
</head>

<div style="display: none;">
    <div id="modal">
    </div>
</div>

<body>
    <div id="textDiv" style="display:none" class="form-group">
        <label for="textarea">WikiData data search:</label>
        <textarea class="form-control" id="textarea" style="resize: none;"></textarea>
    </div>
    <div class="main">
        <div>
            <div class="add-memory-header">
                <div style="display: inline-block; width: 100%;">
                    <div style="float: right;">
                        <button style="height: 26px;" onclick="getLinkedDatasFromMemo()">Search In Memories</button>
                        <button class="btn-primary" id="button-dialog" onclick="autoCompleteSwitch()">WikiData
                            Annotation</button>
                    </div>
                    <div style="float: right;">
                        <textarea id="qryinput" type="text" style="resize: none; height: 26px;"></textarea>
                    </div>
                </div>
            </div>
            <br>
            <br>
            <h1>A Memory</h1>
            <div>
                <div style="width: 100%;" id="editor">
                    <h1>My awesome memory</h1>
                    <p><a class="wikidata" href="//www.wikidata.org/wiki/Q794">Iran</a></p>
                    <p><a class="wikidata" href="//www.wikidata.org/wiki/Q408">Australia</a></p>
                    <p><a class="wikidata" href="//www.wikidata.org/wiki/Q16">Canada</a></p>
                    <p><br /></p>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    var autoCopleteActivated = false;

    function getLinkedDatasFromMemo() {
        var searchText = $('#qryinput').val();
        var select = document.querySelectorAll('p > a');
        var responseArray = [];
        select.forEach(function (val) {
            var splitedArray = val.href.split('/');
            var itemQ = splitedArray[splitedArray.length - 1]
            var response = searchQuery("https://www.wikidata.org/wiki/Special:EntityData/" + itemQ + ".json");
            var entities = response.entities;

            for (var entity in entities) {
                var tempArray = [];
                var claims = entities[entity].claims;
                for (var t in claims) {
                    var claim = claims[t];
                    for (var k in claim){
                    try {
                        var value = claim[k].mainsnak.datavalue.value;
                        var id =value.id;
                        if (id != null){
                            tempArray.push(id);    
                        }
                    } catch (error) {
                        
                    }
                }
                    
                    
                }
                responseArray.push(tempArray);  
            }
        })
        responseArray.forEach(function (val) {
            alert(val.includes(searchText));
        })
        return responseArray;
    }

    //var smt = a();
    //rspns = searchQuery(smt);
    searchAutoComplete();

    function searchAutoComplete() {
        var words = [];
        var data = {};
        $('#qryinput').textcomplete([{
            match: /(^|\b)(\w{2,})$/,
            search: function (term, callback) {
            
                data = searchTextOnWikidata($('#qryinput').val());
                words = [];
                data.search.forEach(element => {
                    words.push(element.label);
                });
                callback($.map(words, function (word) {
                    return word;
                }));
            },
            replace: function (word) {
                var i = 0;
                for (i; i < words.length; i++) {
                    if (words[i] == word) {
                        break;
                    }
                }
                $('#qryinput').val('');
                return data.search[i].title;
            }
        }], {
            maxCount: 20,
            onKeydown: function (e, commands) {
                if (e.keyCode === 39) {
                    var activeLi = $("ul[id*=textcomplete-dropdown-1] li.active");
                    var activeIndex = activeLi.index();

                    imageQ = "https://www.wikidata.org/w/api.php?action=wbgetclaims&entity=" + data.search[
                            activeIndex].title +
                        "&property=P18&format=json"

                    imageSource = '';

                    try {
                        var imgText = searchQuery(imageQ).claims.P18[0].mainsnak.datavalue.value.split(' ')
                            .join(
                                '_');
                        var hash = md5(imgText);
                        var a = hash.substring(0, 1);
                        var b = hash.substring(1, 2);
                        imageSource = "https://upload.wikimedia.org/wikipedia/commons/" + a + "/" + a + b +
                            "/" + imgText;
                    } catch (e) {
                        console.log("Image not found");
                    }

                    openDiag(words[activeIndex], imageSource, data.search[activeIndex].description);
                    return true;
                }
            }
        });
    }

    function closeDiag() {
        $('#textcomplete-dropdown-1').show();
        $('#textcomplete-dropdown-2').show();
    }

    function openDiag(title, imgSource, content) {
        $('#textcomplete-dropdown-1').hide();
        $('#textcomplete-dropdown-2').hide();
        $("#modal").append('<h1><a id="diagTitle" href="">' + title + '</a></h1>')
            .append('<img id="diagImage"  height="250" width="250" src="' + imgSource + '" alt="Image not found";>')
            .append('<p id="diagContent">' + content + '</p>')
            .append('<button data-dialog-close onclick="closeDiag()">Close</button>')
            .dialog({});
    }
    
    function autoCompleteSwitch() {
        if (!autoCopleteActivated) {
            createAutoComplete();
            $('#textDiv').show();
            autoCopleteActivated = true;
        } else {
            destroyAutoComplete();
            autoCopleteActivated = false;
            $('#textDiv').hide();
        }
    }

    function destroyAutoComplete() {
        $('#textarea').textcomplete('destroy');
    }
    
    function getInstances(item) {
        var instance = 'P31';
        var lang = 'en';
        const sparql =
            "SELECT ?item ?instance_of ?instance_ofLabel" +
            " WHERE " +
            "{" +
            " ?item wdt:"+ instance +" wd:" + item +
            " SERVICE wikibase:label { bd:serviceParam wikibase:language \"[AUTO_LANGUAGE],"+ lang +"\" }" +
            " OPTIONAL { ?item wdt:" + instance +" ?instance_of. }" +
            "}";
           
        const url = wdk.sparqlQuery(sparql)
        return url;
    }

    function createAutoComplete() {
        var words = [];
        var data = {};
        $('#textarea').textcomplete([{
            match: /(^|\b)(\w{2,})$/,
            search: function (term, callback) {
                //var smt = a();
                //rspns = searchQuery(smt);
                data = searchTextOnWikidata($('#textarea').val());
                words = [];
                data.search.forEach(element => {
                    words.push(element.label);
                });
                callback($.map(words, function (word) {
                    return word;
                }));
            },
            replace: function (word) {
                var i = 0;
                for (i; i < words.length; i++) {
                    if (words[i] == word) {
                        break;
                    }
                }
                $('.ql-editor').append('<a class="wikidata" href="' + data.search[i].url + '">' + word + '</a>')
                $('#textarea').val('');
                return '';
            }
        }], {
            maxCount: 20,
            onKeydown: function (e, commands) {
                
                if (e.keyCode === 39) {
                    var activeLi = $("ul[id*=textcomplete-dropdown-2] li.active");
                    var activeIndex = activeLi.index();

                    imageQ = "https://www.wikidata.org/w/api.php?action=wbgetclaims&entity=" + data.search[
                            activeIndex].title +
                        "&property=P18&format=json"

                    imageSource = '';

                    try {
                        var imgText = searchQuery(imageQ).claims.P18[0].mainsnak.datavalue.value.split(' ')
                            .join(
                                '_');
                        var hash = md5(imgText);
                        var a = hash.substring(0, 1);
                        var b = hash.substring(1, 2);
                        imageSource = "https://upload.wikimedia.org/wikipedia/commons/" + a + "/" + a + b +
                            "/" + imgText;
                    } catch (e) {
                        console.log("Image not found");
                    }

                    openDiag(words[activeIndex], imageSource, data.search[activeIndex].description);
                    return true;
                }
            }
        });
    }

    function searchTextOnWikidata(text) {
        const Http = new XMLHttpRequest();
        const url = wdk.searchEntities(text, 'en', 20, 'json');
        Http.open("GET", url, false);
        Http.send();

        if (Http.readyState == 4 && Http.status == 200) {
            var response = JSON.parse(Http.response);
            return response;
        }
    }

    function searchQuery(imgQuey) {
        const Http = new XMLHttpRequest();
        const url = imgQuey
        Http.open("GET", url, false);
        Http.send();
        if (Http.readyState == 4 && Http.status == 200) {
            var response = JSON.parse(Http.response);
            return response;
        }
    }
</script>
<script src="./js/wikidata-sdk.js"></script>
<script src="./js/js-md5.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="./js/jquery-dialog.min.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="./js/addmemory.js"></script>
<script src="./js/onepagescroll.js"></script>
<link rel="stylesheet" href="./css/onepage-scroll.css">
<link rel="stylesheet" type="text/css" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU"
    crossorigin="anonymous" />
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="./css/main.css">
<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">


</html>